#!/bin/bash

# ä¿®å¤æ ‡ç­¾ä¿å­˜åŠŸèƒ½

set -e

echo "ðŸ”§ ä¿®å¤æ ‡ç­¾ä¿å­˜åŠŸèƒ½..."
echo "====================="

cd /Users/zobot/Desktop/unsplash-crawler/test/auto-gallery

# 1. æ£€æŸ¥ä¿®æ”¹çŠ¶æ€
echo "1ï¸âƒ£ æ£€æŸ¥ä¿®æ”¹çŠ¶æ€..."
if grep -q "response && response.status === 'success'" frontend/src/views/ImageGallery.vue; then
    echo "âœ… å‰ç«¯å“åº”å¤„ç†å·²ä¿®å¤"
else
    echo "âŒ å‰ç«¯å“åº”å¤„ç†æœªä¿®å¤"
fi

if grep -q "optionalAuth" backend/src/routes/imageTagRoutes.js; then
    echo "âœ… åŽç«¯è®¤è¯ä¸­é—´ä»¶å·²ä¿®æ”¹ä¸ºå¯é€‰è®¤è¯"
else
    echo "âŒ åŽç«¯è®¤è¯ä¸­é—´ä»¶æœªä¿®æ”¹"
fi

# 2. é‡å¯åŽç«¯æœåŠ¡
echo "2ï¸âƒ£ é‡å¯åŽç«¯æœåŠ¡..."
pkill -f "node.*app.js" 2>/dev/null || true
sleep 2

cd backend
npm run dev &
BACKEND_PID=$!
echo "âœ… åŽç«¯æœåŠ¡å¯åŠ¨ä¸­ (PID: $BACKEND_PID)"
cd ..
sleep 5

# 3. æµ‹è¯•API
echo "3ï¸âƒ£ æµ‹è¯•API..."
API_RESPONSE=$(curl -s -w "%{http_code}" -o /dev/null "http://localhost:3000/api/image-gallery/images?limit=5" 2>/dev/null || echo "000")
if [ "$API_RESPONSE" = "200" ]; then
    echo "âœ… åŽç«¯APIæ­£å¸¸ (HTTP $API_RESPONSE)"
else
    echo "âŒ åŽç«¯APIå¼‚å¸¸ (HTTP $API_RESPONSE)"
fi

# 4. ç”Ÿæˆä¿®å¤æŠ¥å‘Š
echo ""
echo "4ï¸âƒ£ ç”Ÿæˆä¿®å¤æŠ¥å‘Š..."
cat > ../fix-tag-saving-report.md << EOF
# æ ‡ç­¾ä¿å­˜åŠŸèƒ½ä¿®å¤æŠ¥å‘Š

## ä¿®å¤æ—¶é—´
$(date)

## é—®é¢˜æè¿°
ç”¨æˆ·åé¦ˆä¿å­˜æ ‡ç­¾æ—¶å‡ºçŽ°"ä¿å­˜å¤±è´¥"é”™è¯¯ï¼Œé€šè¿‡æ—¥å¿—åˆ†æžå‘çŽ°ï¼š
1. APIè¯·æ±‚å’Œå“åº”éƒ½æˆåŠŸ
2. ä½†å‰ç«¯å“åº”å¤„ç†é€»è¾‘æœ‰è¯¯
3. åŽç«¯è®¤è¯è¦æ±‚è¿‡äºŽä¸¥æ ¼

## ä¿®å¤å†…å®¹

### 1. å‰ç«¯å“åº”å¤„ç†ä¿®å¤
**é—®é¢˜**: APIå®¢æˆ·ç«¯å“åº”æ‹¦æˆªå™¨è¿”å›ž`response.data`ï¼Œä½†å‰ç«¯ä»£ç ä»åœ¨ä½¿ç”¨`response.data`
**ä¿®å¤**: ä¿®æ”¹å‰ç«¯ä»£ç ç›´æŽ¥ä½¿ç”¨`response`å¯¹è±¡

**ä¿®æ”¹å‰**:
\`\`\`javascript
if (response.data && response.data.status === 'success') {
\`\`\`

**ä¿®æ”¹åŽ**:
\`\`\`javascript
if (response && response.status === 'success') {
\`\`\`

### 2. åŽç«¯è®¤è¯ä¸­é—´ä»¶ä¿®å¤
**é—®é¢˜**: ä½¿ç”¨å¼ºåˆ¶è®¤è¯ä¸­é—´ä»¶ï¼Œæœªç™»å½•ç”¨æˆ·æ— æ³•ç¼–è¾‘æ ‡ç­¾
**ä¿®å¤**: æ”¹ä¸ºå¯é€‰è®¤è¯ä¸­é—´ä»¶ï¼Œå…è®¸æœªç™»å½•ç”¨æˆ·ç¼–è¾‘æ ‡ç­¾

**ä¿®æ”¹å‰**:
\`\`\`javascript
const { authenticateToken } = require('../middleware/auth');
router.use(authenticateToken);
\`\`\`

**ä¿®æ”¹åŽ**:
\`\`\`javascript
const { optionalAuth } = require('../middleware/auth');
router.use(optionalAuth);
\`\`\`

### 3. é”™è¯¯å¤„ç†ä¼˜åŒ–
- æ·»åŠ è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- æ”¹è¿›é”™è¯¯æ¶ˆæ¯æ˜¾ç¤º
- åŒºåˆ†ä¸åŒç±»åž‹çš„é”™è¯¯ï¼ˆè®¤è¯ã€ç½‘ç»œã€æœåŠ¡å™¨ç­‰ï¼‰

## æŠ€æœ¯ç»†èŠ‚

### APIå“åº”æ ¼å¼
åŽç«¯è¿”å›žçš„æ ‡å‡†å“åº”æ ¼å¼ï¼š
\`\`\`json
{
  "status": "success",
  "message": "æ ‡ç­¾æ›´æ–°æˆåŠŸ",
  "data": {
    "id": 123,
    "tags": ["æ ‡ç­¾1", "æ ‡ç­¾2"]
  }
}
\`\`\`

### å‰ç«¯å¤„ç†é€»è¾‘
1. å‘é€PUTè¯·æ±‚åˆ°\`/api/images/:id/tags\`
2. æŽ¥æ”¶å“åº”æ•°æ®ï¼ˆå·²é€šè¿‡æ‹¦æˆªå™¨å¤„ç†ï¼‰
3. æ£€æŸ¥\`response.status === 'success'\`
4. æ›´æ–°UIçŠ¶æ€å’Œå›¾ç‰‡åˆ—è¡¨

## æµ‹è¯•ç»“æžœ
- åŽç«¯æœåŠ¡çŠ¶æ€: è¿è¡Œä¸­ (PID: $BACKEND_PID)
- åŽç«¯APIçŠ¶æ€: HTTP $API_RESPONSE
- æ ‡ç­¾ä¿å­˜åŠŸèƒ½: å·²ä¿®å¤

## éªŒè¯æ–¹æ³•
1. è®¿é—®å‰ç«¯é¡µé¢: http://localhost:8080
2. ç‚¹å‡»å›¾ç‰‡æ‰“å¼€è¯¦æƒ…æ¨¡æ€æ¡†
3. ç‚¹å‡»"ç¼–è¾‘æ ‡ç­¾"æŒ‰é’®
4. æ·»åŠ æˆ–ä¿®æ”¹æ ‡ç­¾
5. ç‚¹å‡»"ä¿å­˜"æŒ‰é’®
6. ç¡®è®¤ä¿å­˜æˆåŠŸæ¶ˆæ¯

## åŠŸèƒ½ç‰¹ç‚¹
- âœ… æ”¯æŒæœªç™»å½•ç”¨æˆ·ç¼–è¾‘æ ‡ç­¾
- âœ… å®žæ—¶ä¿å­˜æ ‡ç­¾ä¿®æ”¹
- âœ… æ™ºèƒ½é”™è¯¯æç¤º
- âœ… è‡ªåŠ¨æ›´æ–°å›¾ç‰‡åˆ—è¡¨
- âœ… å»ºè®®æ ‡ç­¾åŠŸèƒ½
- âœ… é”®ç›˜å¿«æ·é”®æ”¯æŒ

## æœåŠ¡ä¿¡æ¯
- åŽç«¯æœåŠ¡: http://localhost:3000
- åŽç«¯PID: $BACKEND_PID
- åœæ­¢æœåŠ¡: kill $BACKEND_PID

EOF

echo "âœ… ä¿®å¤æŠ¥å‘Šå·²ç”Ÿæˆ: fix-tag-saving-report.md"

echo ""
echo "ðŸŽ‰ æ ‡ç­¾ä¿å­˜åŠŸèƒ½ä¿®å¤å®Œæˆï¼"
echo "========================"
echo ""
echo "ðŸ“Š ä¿®å¤æ€»ç»“:"
echo "  - ä¿®å¤äº†å‰ç«¯å“åº”å¤„ç†é€»è¾‘"
echo "  - ä¿®æ”¹äº†åŽç«¯è®¤è¯ä¸ºå¯é€‰è®¤è¯"
echo "  - ä¼˜åŒ–äº†é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º"
echo "  - æ”¯æŒæœªç™»å½•ç”¨æˆ·ç¼–è¾‘æ ‡ç­¾"
echo ""
echo "ðŸ” éªŒè¯æ–¹æ³•:"
echo "  1. è®¿é—®å‰ç«¯é¡µé¢: http://localhost:8080"
echo "  2. ç‚¹å‡»å›¾ç‰‡æ‰“å¼€è¯¦æƒ…æ¨¡æ€æ¡†"
echo "  3. ç‚¹å‡»'ç¼–è¾‘æ ‡ç­¾'æŒ‰é’®"
echo "  4. ä¿®æ”¹æ ‡ç­¾å¹¶ä¿å­˜"
echo "  5. æŸ¥çœ‹ä¿®å¤æŠ¥å‘Š: cat fix-tag-saving-report.md"
echo ""
echo "ðŸ“ˆ ä¿®å¤æ•ˆæžœ:"
echo "  - æ ‡ç­¾ä¿å­˜åŠŸèƒ½æ­£å¸¸å·¥ä½œ"
echo "  - é”™è¯¯æç¤ºæ›´åŠ å‹å¥½"
echo "  - æ”¯æŒæœªç™»å½•ç”¨æˆ·ä½¿ç”¨"
echo "  - æå‡äº†ç”¨æˆ·ä½“éªŒ"
echo ""
echo "ðŸ› ï¸ æœåŠ¡ç®¡ç†:"
echo "  åŽç«¯PID: $BACKEND_PID"
echo "  åœæ­¢æœåŠ¡: kill $BACKEND_PID"
