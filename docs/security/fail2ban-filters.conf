# Fail2ban过滤规则文件
# 每个过滤器对应一个独立文件，安装到 /etc/fail2ban/filter.d/

# ==========================================
# 1. 恶意路径访问过滤器
# 文件: /etc/fail2ban/filter.d/cardesignspace-malicious.conf
# ==========================================
[Definition]

# 匹配恶意路径访问
failregex = ^<HOST> .* "(GET|POST|HEAD) /(phpinfo|wp-admin|wp-login|\.env|\.git|test\.php|console|wiki|_ignition|phpmyadmin|config|setup|install|shell|backdoor|webshell).*" (403|404|500)

# 匹配恶意User-Agent
            ^<HOST> .* "(bot|crawler|spider|scraper|scanner|probe|wget|curl|python-requests|java|nikto|sqlmap)" .*

# 匹配SQL注入尝试
            ^<HOST> .* "(union.*select|select.*from|insert.*into|delete.*from|drop.*table|exec.*xp_|' or '1'='1)" .*

ignoreregex =


# ==========================================
# 2. 敏感文件访问过滤器
# 文件: /etc/fail2ban/filter.d/cardesignspace-sensitive.conf
# ==========================================
[Definition]

# 匹配敏感文件访问
failregex = ^<HOST> .* "(GET|POST) /(\.env|\.git|\.svn|\.htaccess|composer\.json|package\.json|web\.config|php\.ini|\.DS_Store).*" .*

# 匹配配置文件探测
            ^<HOST> .* "(GET|POST) .*(config|configuration|settings|credentials|secrets|password).*\.(php|json|xml|yml|yaml|ini|conf|cfg)" .*

ignoreregex =


# ==========================================
# 3. API频率限制过滤器
# 文件: /etc/fail2ban/filter.d/cardesignspace-api-limit.conf
# ==========================================
[Definition]

# 匹配Nginx限流错误
failregex = limiting requests, excess: .* by zone "api", client: <HOST>
            limiting requests, excess: .* by zone "general", client: <HOST>

ignoreregex =


# ==========================================
# 4. 暴力破解过滤器
# 文件: /etc/fail2ban/filter.d/cardesignspace-bruteforce.conf
# ==========================================
[Definition]

# 匹配登录失败
failregex = ^<HOST> .* "POST /api/auth/login.*" 401
            ^<HOST> .* "POST /api/auth/register.*" 400

# 匹配频繁的403错误
            ^<HOST> .* "(GET|POST) .*" 403

ignoreregex =


# ==========================================
# 安装说明
# ==========================================
# 
# 1. 安装fail2ban:
#    sudo apt-get install fail2ban
#
# 2. 复制jail配置:
#    sudo cp fail2ban-setup.conf /etc/fail2ban/jail.d/cardesignspace.conf
#
# 3. 创建各个过滤器文件:
#    sudo nano /etc/fail2ban/filter.d/cardesignspace-malicious.conf
#    (复制上面对应的[Definition]部分)
#
# 4. 测试配置:
#    sudo fail2ban-regex /var/log/nginx/cardesignspace_access.log /etc/fail2ban/filter.d/cardesignspace-malicious.conf
#
# 5. 重启fail2ban:
#    sudo systemctl restart fail2ban
#
# 6. 查看状态:
#    sudo fail2ban-client status
#    sudo fail2ban-client status cardesignspace-malicious
#
# 7. 手动解封IP:
#    sudo fail2ban-client set cardesignspace-malicious unbanip <IP地址>


