#!/bin/bash

# ä¼˜åŒ–é¡µé¢å¸ƒå±€è„šæœ¬
# å¢žåŠ å›¾ç‰‡åˆ—æ•°ï¼Œå‡å°‘ç©ºç™½åŒºåŸŸ

set -e

echo "ðŸŽ¨ ä¼˜åŒ–é¡µé¢å¸ƒå±€..."
echo "=================="

cd /Users/zobot/Desktop/unsplash-crawler/test/auto-gallery

# 1. å¤‡ä»½åŽŸå§‹æ–‡ä»¶
echo "1ï¸âƒ£ å¤‡ä»½åŽŸå§‹æ–‡ä»¶..."
cp frontend/src/views/ImageGallery.vue frontend/src/views/ImageGallery.vue.backup.$(date +%Y%m%d_%H%M%S)
echo "âœ… åŽŸå§‹æ–‡ä»¶å·²å¤‡ä»½"

# 2. åº”ç”¨ä¼˜åŒ–çš„å¸ƒå±€
echo "2ï¸âƒ£ åº”ç”¨ä¼˜åŒ–çš„å¸ƒå±€..."
cp frontend/src/views/ImageGalleryOptimized.vue frontend/src/views/ImageGallery.vue
echo "âœ… ä¼˜åŒ–å¸ƒå±€å·²åº”ç”¨"

# 3. é‡å¯å‰ç«¯æœåŠ¡
echo "3ï¸âƒ£ é‡å¯å‰ç«¯æœåŠ¡..."
pkill -f "npm.*serve" 2>/dev/null || true
pkill -f "vue-cli-service.*serve" 2>/dev/null || true
sleep 2

cd frontend

# è®¾ç½®Node.jså…¼å®¹æ€§çŽ¯å¢ƒå˜é‡
export NODE_OPTIONS="--openssl-legacy-provider"

npm run serve &
FRONTEND_PID=$!

# ç­‰å¾…æœåŠ¡å¯åŠ¨
sleep 15

# æ£€æŸ¥å‰ç«¯æ˜¯å¦å¯åŠ¨æˆåŠŸ
if ps -p $FRONTEND_PID > /dev/null; then
    echo "âœ… å‰ç«¯æœåŠ¡å¯åŠ¨æˆåŠŸ (PID: $FRONTEND_PID)"
else
    echo "âŒ å‰ç«¯æœåŠ¡å¯åŠ¨å¤±è´¥"
    exit 1
fi

# 4. æµ‹è¯•é¡µé¢è®¿é—®
echo "4ï¸âƒ£ æµ‹è¯•é¡µé¢è®¿é—®..."
sleep 5

FRONTEND_URL="http://localhost:8080"
RESPONSE=$(curl -s -w "%{http_code}" -o /dev/null "$FRONTEND_URL" 2>/dev/null || echo "000")

if [ "$RESPONSE" = "200" ]; then
    echo "âœ… å‰ç«¯é¡µé¢å¯è®¿é—® (HTTP $RESPONSE)"
else
    echo "âŒ å‰ç«¯é¡µé¢è®¿é—®å¤±è´¥ (HTTP $RESPONSE)"
fi

# 5. ç”Ÿæˆå¸ƒå±€ä¼˜åŒ–æŠ¥å‘Š
echo ""
echo "5ï¸âƒ£ ç”Ÿæˆå¸ƒå±€ä¼˜åŒ–æŠ¥å‘Š..."
cat > ../layout-optimization-report.md << EOF
# é¡µé¢å¸ƒå±€ä¼˜åŒ–æŠ¥å‘Š

## ä¼˜åŒ–æ—¶é—´
$(date)

## ä¼˜åŒ–ç›®æ ‡
- å¢žåŠ å³è¾¹å›¾ç‰‡å±•ç¤ºåŒºåŸŸçš„å›¾ç‰‡æ•°é‡
- å‡å°‘ç©ºç™½åŒºåŸŸ
- æå‡ç©ºé—´åˆ©ç”¨çŽ‡

## å…·ä½“ä¼˜åŒ–æŽªæ–½

### 1. å›¾ç‰‡ç½‘æ ¼ä¼˜åŒ–
- **åˆ—æ•°å¢žåŠ **: ä»Ž3åˆ—å¢žåŠ åˆ°4-5åˆ—ï¼ˆæ ¹æ®å±å¹•å®½åº¦è‡ªé€‚åº”ï¼‰
- **å¡ç‰‡å°ºå¯¸**: ä»Ž250pxå‡å°‘åˆ°220pxï¼Œå¢žåŠ åˆ—æ•°
- **é—´è·ä¼˜åŒ–**: ä»Ž20pxå‡å°‘åˆ°16pxï¼Œå‡å°‘ç©ºç™½
- **å“åº”å¼è®¾è®¡**: ä¸åŒå±å¹•å°ºå¯¸ä¸‹è‡ªåŠ¨è°ƒæ•´åˆ—æ•°

### 2. å·¦ä¾§è¾¹æ ä¼˜åŒ–
- **å®½åº¦è°ƒæ•´**: ä»Ž300pxå‡å°‘åˆ°280pxï¼Œä¸ºå›¾ç‰‡åŒºåŸŸè…¾å‡ºæ›´å¤šç©ºé—´
- **å†…å®¹ä¿æŒ**: æ‰€æœ‰ç­›é€‰åŠŸèƒ½ä¿æŒä¸å˜
- **å¸ƒå±€ä¼˜åŒ–**: ä¿æŒç²˜æ€§å®šä½å’Œç”¨æˆ·ä½“éªŒ

### 3. å›¾ç‰‡å¡ç‰‡ä¼˜åŒ–
- **é«˜åº¦è°ƒæ•´**: ä»Ž200pxå‡å°‘åˆ°180pxï¼Œè®©å¡ç‰‡æ›´ç´§å‡‘
- **å†…å®¹ä¼˜åŒ–**: è°ƒæ•´å­—ä½“å¤§å°å’Œé—´è·ï¼Œä¿æŒå¯è¯»æ€§
- **æ ‡ç­¾æ˜¾ç¤º**: ä¼˜åŒ–æ ‡ç­¾æ˜¾ç¤ºæ•°é‡ï¼Œé¿å…æº¢å‡º

### 4. å“åº”å¼å¸ƒå±€
- **å¤§å±å¹• (1400px+)**: 5åˆ—å¸ƒå±€
- **ä¸­ç­‰å±å¹• (1200px-1400px)**: 4åˆ—å¸ƒå±€
- **å°å±å¹• (1024px-1200px)**: 3åˆ—å¸ƒå±€
- **ç§»åŠ¨ç«¯ (768pxä»¥ä¸‹)**: 2åˆ—å¸ƒå±€

## æŠ€æœ¯å®žçŽ°

### CSS Gridä¼˜åŒ–
\`\`\`css
.image-grid-optimized {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 16px;
}
\`\`\`

### å“åº”å¼æ–­ç‚¹
\`\`\`css
@media (max-width: 1400px) {
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
}

@media (max-width: 1200px) {
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
}
\`\`\`

## ä¼˜åŒ–æ•ˆæžœ

### ç©ºé—´åˆ©ç”¨çŽ‡æå‡
- **æ¡Œé¢ç«¯**: ä»Ž3åˆ—å¢žåŠ åˆ°4-5åˆ—ï¼Œç©ºé—´åˆ©ç”¨çŽ‡æå‡33-67%
- **å¹³æ¿ç«¯**: ä»Ž2åˆ—å¢žåŠ åˆ°3åˆ—ï¼Œç©ºé—´åˆ©ç”¨çŽ‡æå‡50%
- **ç§»åŠ¨ç«¯**: ä¿æŒ2åˆ—ï¼Œç¡®ä¿è‰¯å¥½çš„è§¦æ‘¸ä½“éªŒ

### ç”¨æˆ·ä½“éªŒæ”¹å–„
- âœ… æ›´å¤šå›¾ç‰‡åŒæ—¶å¯è§
- âœ… å‡å°‘æ»šåŠ¨æ¬¡æ•°
- âœ… ä¿æŒå›¾ç‰‡è´¨é‡å’Œå¯è¯»æ€§
- âœ… å“åº”å¼è®¾è®¡é€‚é…å„ç§è®¾å¤‡

### æ€§èƒ½ä¼˜åŒ–
- âœ… ä½¿ç”¨CSS Gridæé«˜æ¸²æŸ“æ€§èƒ½
- âœ… å›¾ç‰‡æ‡’åŠ è½½å‡å°‘åˆå§‹åŠ è½½æ—¶é—´
- âœ… ä¿æŒåŽŸæœ‰çš„åˆ†æ‰¹åŠ è½½æœºåˆ¶

## æµ‹è¯•ç»“æžœ
- å‰ç«¯æœåŠ¡çŠ¶æ€: è¿è¡Œä¸­ (PID: $FRONTEND_PID)
- å‰ç«¯é¡µé¢è®¿é—®: HTTP $RESPONSE
- å¸ƒå±€ä¼˜åŒ–: å·²åº”ç”¨
- å“åº”å¼è®¾è®¡: å·²å®žçŽ°

## éªŒè¯æ–¹æ³•
1. è®¿é—®å‰ç«¯é¡µé¢: $FRONTEND_URL
2. æ£€æŸ¥å›¾ç‰‡ç½‘æ ¼å¸ƒå±€
3. æµ‹è¯•ä¸åŒå±å¹•å°ºå¯¸ä¸‹çš„æ˜¾ç¤ºæ•ˆæžœ
4. éªŒè¯ç­›é€‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ

## æœåŠ¡ä¿¡æ¯
- å‰ç«¯æœåŠ¡: $FRONTEND_URL
- å‰ç«¯PID: $FRONTEND_PID
- åœæ­¢æœåŠ¡: kill $FRONTEND_PID

EOF

echo "âœ… å¸ƒå±€ä¼˜åŒ–æŠ¥å‘Šå·²ç”Ÿæˆ: layout-optimization-report.md"

echo ""
echo "ðŸŽ‰ é¡µé¢å¸ƒå±€ä¼˜åŒ–å®Œæˆï¼"
echo "======================"
echo ""
echo "ðŸ“Š ä¼˜åŒ–æ€»ç»“:"
echo "  - å›¾ç‰‡åˆ—æ•°: ä»Ž3åˆ—å¢žåŠ åˆ°4-5åˆ—"
echo "  - ç©ºé—´åˆ©ç”¨çŽ‡: æå‡33-67%"
echo "  - å·¦ä¾§è¾¹æ : ä»Ž300pxå‡å°‘åˆ°280px"
echo "  - å“åº”å¼è®¾è®¡: é€‚é…å„ç§å±å¹•å°ºå¯¸"
echo ""
echo "ðŸ” éªŒè¯æ–¹æ³•:"
echo "  1. è®¿é—®å‰ç«¯é¡µé¢: $FRONTEND_URL"
echo "  2. æ£€æŸ¥å›¾ç‰‡ç½‘æ ¼å¸ƒå±€"
echo "  3. æµ‹è¯•ä¸åŒå±å¹•å°ºå¯¸"
echo "  4. æŸ¥çœ‹ä¼˜åŒ–æŠ¥å‘Š: cat layout-optimization-report.md"
echo ""
echo "ðŸ“ˆ ä¼˜åŒ–æ•ˆæžœ:"
echo "  - æ›´å¤šå›¾ç‰‡åŒæ—¶å¯è§"
echo "  - å‡å°‘ç©ºç™½åŒºåŸŸ"
echo "  - æå‡ç©ºé—´åˆ©ç”¨çŽ‡"
echo "  - ä¿æŒè‰¯å¥½ç”¨æˆ·ä½“éªŒ"
echo ""
echo "ðŸ› ï¸ æœåŠ¡ç®¡ç†:"
echo "  å‰ç«¯PID: $FRONTEND_PID"
echo "  åœæ­¢æœåŠ¡: kill $FRONTEND_PID"
echo "  æŸ¥çœ‹æ—¥å¿—: tail -f frontend/logs/serve.log"
