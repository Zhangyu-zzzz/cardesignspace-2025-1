# TK02 上传流水线与图片变体（并行工单）

## 范围
- 上传成功后入队：生成 thumb/small/medium/large/webp，写入 image_assets
- 生成失败重试与告警；最优 URL 选择策略（bestUrl）

## 交付物
- 队列/任务实现与配置
- 变体生成模块（sharp）与单元测试
- bestUrl 选择逻辑（优先 webp，回退 jpeg，按容器宽度）

## 接口影响
- 上传接口响应新增 assets 字段；不改旧字段

## 任务清单
- [ ] 队列与任务定义
- [ ] 变体生成与落库
- [ ] 重试/告警与幂等
- [ ] bestUrl 选择逻辑与回归

## 验收标准
- 生成成功率 ≥98%，失败可重试
- 变体命中率 ≥90%（前台将使用 bestUrl）

## 指标
- 任务时延/失败率、平均生成耗时、CDN 命中率（后置观测）

## 风险/回滚
- 风险：磁盘与 CPU 峰值；回滚：暂停任务消费、降级使用原图

## 依赖/排期
- 依赖：TK01
- 预计：3 人日
