<template>
  <div class="smart-search">
    <div class="search-header">
      <h1 class="page-title">æ™ºèƒ½æœç´¢</h1>
      <p class="page-description">ç»“åˆå…³ç³»æ•°æ®åº“å’Œå‘é‡æ•°æ®åº“ï¼Œæ™ºèƒ½è¯†åˆ«å“ç‰Œä¿¡æ¯å¹¶è¿›è¡Œè¯­ä¹‰æœç´¢</p>
      
      <!-- æœç´¢æ¡† -->
      <div class="search-box-container">
        <el-input
          v-model="searchQuery"
          placeholder="ä¾‹å¦‚ï¼šçº¢è‰²çš„å®é©¬SUVã€å¥”é©°æ¦‚å¿µè½¦ã€å¥¥è¿ªA4"
          class="search-input"
          size="large"
          @keyup.enter.native="performSearch"
          clearable
        >
          <el-button 
            slot="append" 
            icon="el-icon-search"
            @click="performSearch"
            :loading="loading"
          >
            æœç´¢
          </el-button>
        </el-input>
      </div>

      <!-- æœç´¢ä¿¡æ¯æç¤º -->
      <div v-if="searchInfo" class="search-info">
        <el-tag v-if="searchInfo.brandInfo" type="success" size="small">
          è¯†åˆ«åˆ°å“ç‰Œ: {{ searchInfo.brandInfo.name }}
        </el-tag>
        <el-tag type="info" size="small">
          MySQLç»“æœ: {{ searchInfo.mysqlResultsCount }} å¼ 
        </el-tag>
        <el-tag type="warning" size="small">
          å‘é‡ç»“æœ: {{ searchInfo.vectorResultsCount }} å¼ 
        </el-tag>
      </div>
    </div>

    <!-- åŠ è½½çŠ¶æ€ -->
    <div v-if="loading" class="loading-container" v-loading="loading" element-loading-text="æ­£åœ¨æœç´¢...">
      <div style="min-height: 400px;"></div>
    </div>

    <!-- æœç´¢ç»“æœ -->
    <div v-else-if="images.length > 0" class="results-container">
      <div class="results-header">
        <span class="results-count">
          æ‰¾åˆ° {{ pagination.total }} å¼ å›¾ç‰‡ï¼Œå·²åŠ è½½ {{ images.length }} å¼ 
        </span>
      </div>

      <!-- å›¾ç‰‡ç½‘æ ¼ -->
      <div class="image-grid">
        <div 
          v-for="image in images" 
          :key="image.id" 
          class="image-card"
          @click="openImageModal(image)"
        >
          <div class="image-container">
            <img 
              :src="image.bestUrl || image.url" 
              :alt="image.filename"
              @load="onImageLoad"
              @error="onImageError"
              loading="lazy"
            />
            <div class="image-overlay">
              <div class="model-name">{{ image.model?.name || image.Model?.name || 'æœªçŸ¥è½¦å‹' }}</div>
              <div class="brand-name">{{ image.brand?.name || image.model?.Brand?.name || '' }}</div>
            </div>
          </div>
          
          <div class="image-details">
            <div class="filename">{{ image.filename }}</div>
            
            <!-- æ ‡ç­¾æ˜¾ç¤º -->
            <div v-if="image.tags && image.tags.length > 0" class="tags-display">
              <span 
                v-for="(tag, index) in image.tags.slice(0, 3)" 
                :key="index" 
                class="tag"
              >
                {{ tag }}
              </span>
              <span v-if="image.tags.length > 3" class="more-tags">
                +{{ image.tags.length - 3 }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- åŠ è½½æ›´å¤šæç¤º -->
      <div v-if="loadingMore" class="loading-more">
        <i class="el-icon-loading"></i>
        <span>æ­£åœ¨åŠ è½½æ›´å¤š...</span>
      </div>
      <div v-else-if="hasMore" class="load-more-hint">
        æ»šåŠ¨åˆ°åº•éƒ¨è‡ªåŠ¨åŠ è½½æ›´å¤š
      </div>
      <div v-else-if="images.length > 0" class="no-more-hint">
        å·²åŠ è½½å…¨éƒ¨ {{ pagination.total }} å¼ å›¾ç‰‡
      </div>
    </div>

    <!-- ç©ºçŠ¶æ€ -->
    <div v-else-if="hasSearched && !loading" class="empty-state">
      <el-empty description="æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å›¾ç‰‡ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯">
        <el-button type="primary" @click="clearSearch">é‡æ–°æœç´¢</el-button>
      </el-empty>
    </div>

    <!-- åˆå§‹æç¤º -->
    <div v-else class="initial-hint">
      <el-card class="hint-card">
        <div slot="header">
          <span>ğŸ’¡ ä½¿ç”¨æç¤º</span>
        </div>
        <ul class="hint-list">
          <li>è¾“å…¥å“ç‰Œåç§°ï¼ˆå¦‚"å®é©¬"ã€"å¥”é©°"ï¼‰è¿›è¡Œç²¾ç¡®åŒ¹é…</li>
          <li>è¾“å…¥æè¿°æ€§è¯æ±‡ï¼ˆå¦‚"çº¢è‰²çš„"ã€"è¿åŠ¨"ï¼‰è¿›è¡Œè¯­ä¹‰æœç´¢</li>
          <li>å¯ä»¥ç»„åˆä½¿ç”¨ï¼Œå¦‚"çº¢è‰²çš„å®é©¬SUV"</li>
          <li>ç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«å“ç‰Œä¿¡æ¯å¹¶ä½¿ç”¨å…³ç³»æ•°æ®åº“ç²¾ç¡®åŒ¹é…</li>
          <li>å…¶ä»–æè¿°æ€§ä¿¡æ¯ä¼šä½¿ç”¨å‘é‡æ•°æ®åº“è¿›è¡Œè¯­ä¹‰æœç´¢</li>
        </ul>
      </el-card>
    </div>

    <!-- å›¾ç‰‡è¯¦æƒ…æ¨¡æ€æ¡† -->
    <el-dialog
      :visible.sync="showModal"
      :title="selectedImage?.filename"
      width="80%"
      class="image-modal"
    >
      <div v-if="selectedImage" class="modal-content">
        <div class="modal-image">
          <img :src="selectedImage.bestUrl || selectedImage.url" :alt="selectedImage.filename">
        </div>
        
        <div class="modal-info">
          <div class="info-item">
            <label>æ–‡ä»¶å:</label>
            <span>{{ selectedImage.filename }}</span>
          </div>
          <div class="info-item" v-if="selectedImage.model || selectedImage.Model">
            <label>è½¦å‹:</label>
            <span>{{ selectedImage.model?.name || selectedImage.Model?.name }}</span>
          </div>
          <div class="info-item" v-if="selectedImage.brand || selectedImage.model?.Brand">
            <label>å“ç‰Œ:</label>
            <span>{{ selectedImage.brand?.name || selectedImage.model?.Brand?.name }}</span>
          </div>
          <div class="info-item" v-if="selectedImage.model || selectedImage.Model">
            <label>ç±»å‹:</label>
            <span>{{ selectedImage.model?.type || selectedImage.Model?.type }}</span>
          </div>
          <div class="info-item" v-if="selectedImage.tags && selectedImage.tags.length > 0">
            <label>æ ‡ç­¾:</label>
            <div class="tags-list">
              <span v-for="tag in selectedImage.tags" :key="tag" class="tag">
                {{ tag }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </el-dialog>
  </div>
</template>

<script>
import { apiClient } from '@/services/api'

export default {
  name: 'SmartSearch',
  data() {
    return {
      searchQuery: '',
      images: [],
      loading: false,
      loadingMore: false,
      hasSearched: false,
      hasMore: false,
      pagination: {
        page: 1,
        limit: 20,
        total: 0,
        pages: 0
      },
      searchInfo: null,
      showModal: false,
      selectedImage: null,
      scrollHandler: null
    }
  },
  mounted() {
    // æ·»åŠ æ»šåŠ¨ç›‘å¬
    this.scrollHandler = this.handleScroll.bind(this);
    window.addEventListener('scroll', this.scrollHandler);
  },
  beforeDestroy() {
    // ç§»é™¤æ»šåŠ¨ç›‘å¬
    if (this.scrollHandler) {
      window.removeEventListener('scroll', this.scrollHandler);
    }
  },
  methods: {
    async performSearch() {
      if (!this.searchQuery.trim()) {
        this.$message.warning('è¯·è¾“å…¥æœç´¢å…³é”®è¯')
        return
      }

      this.loading = true
      this.hasSearched = true
      this.pagination.page = 1
      this.images = [] // æ¸…ç©ºä¹‹å‰çš„å›¾ç‰‡

      try {
        await this.loadImages()
      } catch (error) {
        console.error('æœç´¢å¤±è´¥:', error)
        this.$message.error('æœç´¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•')
      } finally {
        this.loading = false
      }
    },

    async loadImages(isLoadMore = false) {
      try {
        if (isLoadMore) {
          this.loadingMore = true
        }

        const response = await apiClient.get('/smart-search', {
          params: {
            q: this.searchQuery,
            page: this.pagination.page,
            limit: this.pagination.limit
          }
        })

        // æ³¨æ„ï¼šapiClientçš„å“åº”æ‹¦æˆªå™¨å·²ç»è¿”å›äº†response.data
        if (response.status === 'success') {
          const newImages = response.data.images || []
          
          if (isLoadMore) {
            // åŠ è½½æ›´å¤šï¼šè¿½åŠ åˆ°ç°æœ‰åˆ—è¡¨
            this.images = [...this.images, ...newImages]
          } else {
            // æ–°æœç´¢ï¼šæ›¿æ¢åˆ—è¡¨
            this.images = newImages
          }
          
          this.pagination = response.data.pagination || this.pagination
          this.hasMore = response.data.pagination?.hasMore || false
          this.searchInfo = response.data.searchInfo || null
          
          // è°ƒè¯•æ—¥å¿—
          console.log('æœç´¢å“åº”:', {
            imagesCount: this.images.length,
            newImagesCount: newImages.length,
            hasMore: this.hasMore,
            total: this.pagination.total,
            searchInfo: this.searchInfo,
            vectorResultsCount: this.searchInfo?.vectorResultsCount,
            mysqlResultsCount: this.searchInfo?.mysqlResultsCount
          })
        } else {
          throw new Error(response.message || 'æœç´¢å¤±è´¥')
        }
      } catch (error) {
        console.error('åŠ è½½å›¾ç‰‡å¤±è´¥:', error)
        console.error('é”™è¯¯è¯¦æƒ…:', {
          message: error.message,
          response: error.response?.data,
          status: error.response?.status,
          config: error.config
        })
        if (!isLoadMore) {
          throw error
        }
      } finally {
        if (isLoadMore) {
          this.loadingMore = false
        }
      }
    },

    handleScroll() {
      // æ£€æŸ¥æ˜¯å¦æ»šåŠ¨åˆ°åº•éƒ¨
      if (this.loadingMore || !this.hasMore || this.loading) {
        return
      }

      const scrollTop = window.pageYOffset || document.documentElement.scrollTop
      const windowHeight = window.innerHeight
      const documentHeight = document.documentElement.scrollHeight

      // å½“è·ç¦»åº•éƒ¨200pxæ—¶å¼€å§‹åŠ è½½
      if (scrollTop + windowHeight >= documentHeight - 200) {
        this.loadMore()
      }
    },

    async loadMore() {
      if (!this.hasMore || this.loadingMore) {
        return
      }

      this.pagination.page += 1
      await this.loadImages(true)
    },

    openImageModal(image) {
      this.selectedImage = image
      this.showModal = true
    },

    clearSearch() {
      this.searchQuery = ''
      this.images = []
      this.hasSearched = false
      this.hasMore = false
      this.searchInfo = null
      this.pagination.page = 1
    },

    onImageLoad() {
      // å›¾ç‰‡åŠ è½½å®Œæˆ
    },

    onImageError(event) {
      // å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå¯ä»¥è®¾ç½®é»˜è®¤å›¾ç‰‡
      event.target.src = '/default-avatar.svg'
    }
  }
}
</script>

<style scoped>
.smart-search {
  padding: 40px 20px;
  max-width: 1800px;
  margin: 0 auto;
  min-height: calc(100vh - 100px);
  background-color: #f5f7fa;
}

.search-header {
  margin-bottom: 30px;
  background: white;
  padding: 30px;
  border-radius: 8px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
}

.page-title {
  font-size: 32px;
  font-weight: bold;
  color: #333;
  margin-bottom: 10px;
}

.page-description {
  font-size: 14px;
  color: #666;
  margin-bottom: 20px;
}

.search-box-container {
  max-width: 800px;
  margin-bottom: 20px;
  margin-top: 30px;
}

.search-input {
  width: 100%;
}

/* ç¡®ä¿è¾“å…¥æ¡†å¯è§ */
.search-input >>> .el-input__inner {
  background-color: #fff !important;
  color: #333 !important;
  border: 1px solid #dcdfe6 !important;
  font-size: 16px !important;
  padding: 0 15px !important;
  height: 48px !important;
  line-height: 48px !important;
}

.search-input >>> .el-input__inner::placeholder {
  color: #999 !important;
}

.search-input >>> .el-input__inner:focus {
  border-color: #409eff !important;
  outline: none !important;
}

.search-input >>> .el-input-group__append {
  background-color: #409eff !important;
  border-color: #409eff !important;
  color: #fff !important;
  padding: 0 20px !important;
}

.search-input >>> .el-input-group__append .el-button {
  color: #fff !important;
  font-size: 16px !important;
}

.search-info {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 15px;
}

.loading-container {
  min-height: 400px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.results-container {
  margin-top: 20px;
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
}

.results-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding: 10px 0;
  border-bottom: 1px solid #eee;
}

.results-count {
  font-size: 16px;
  font-weight: bold;
  color: #333;
}

.results-page {
  font-size: 14px;
  color: #666;
}

/* å›¾ç‰‡ç½‘æ ¼ */
.image-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 16px;
  margin-bottom: 40px;
}

.image-card {
  background: white;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}

.image-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(220, 53, 69, 0.15);
}

.image-container {
  position: relative;
  height: 180px;
  overflow: hidden;
}

.image-container img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s;
}

.image-card:hover .image-container img {
  transform: scale(1.05);
}

.image-overlay {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: linear-gradient(transparent, rgba(0,0,0,0.7));
  padding: 12px;
  color: white;
}

.model-name {
  font-weight: bold;
  font-size: 13px;
  margin-bottom: 3px;
}

.brand-name {
  font-size: 11px;
  opacity: 0.9;
}

.image-details {
  padding: 12px;
}

.filename {
  font-size: 11px;
  color: #666;
  margin-bottom: 6px;
  word-break: break-all;
}

.tags-display {
  display: flex;
  flex-wrap: wrap;
  gap: 3px;
  margin-bottom: 6px;
}

.tag {
  padding: 2px 5px;
  border-radius: 3px;
  font-size: 10px;
  background: #f0f0f0;
  color: #555;
}

.more-tags {
  font-size: 10px;
  color: #999;
  padding: 2px 5px;
}

.loading-more,
.load-more-hint,
.no-more-hint {
  margin-top: 30px;
  text-align: center;
  padding: 20px;
  color: #909399;
  font-size: 14px;
}

.loading-more {
  color: #409EFF;
}

.loading-more i {
  margin-right: 8px;
  font-size: 16px;
}

.no-more-hint {
  color: #67C23A;
}

.empty-state {
  min-height: 400px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
  margin-top: 20px;
}

.initial-hint {
  margin-top: 40px;
}

.hint-card {
  max-width: 800px;
  margin: 0 auto;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
}

.hint-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.hint-list li {
  padding: 8px 0;
  border-bottom: 1px solid #f0f0f0;
  color: #666;
}

.hint-list li:last-child {
  border-bottom: none;
}

/* æ¨¡æ€æ¡†æ ·å¼ */
.image-modal .modal-content {
  display: flex;
  gap: 20px;
}

.modal-image {
  flex: 1;
  max-width: 60%;
}

.modal-image img {
  width: 100%;
  height: auto;
  border-radius: 8px;
}

.modal-info {
  flex: 1;
  padding: 20px;
}

.info-item {
  margin-bottom: 15px;
}

.info-item label {
  font-weight: bold;
  color: #333;
  display: inline-block;
  min-width: 80px;
  margin-right: 10px;
}

.info-item span {
  color: #666;
}

.tags-list {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  margin-top: 5px;
}

@media (max-width: 768px) {
  .smart-search {
    padding: 10px;
  }

  .image-grid {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 12px;
  }

  .image-container {
    height: 150px;
  }

  .modal-content {
    flex-direction: column;
  }

  .modal-image, .modal-info {
    max-width: 100%;
  }
}
</style>

